name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch: # Manual trigger

env:
  AWS_REGION: us-east-1
  ECR_REGISTRY: 223882168768.dkr.ecr.us-east-1.amazonaws.com
  ECS_CLUSTER: faxi-prod-cluster

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: production  # Requires approval in GitHub environment settings
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # Need history to detect changes

      - name: Check for migration changes
        id: migration-check
        run: |
          # Check if any migration files changed in this push
          if git diff --name-only HEAD~1 HEAD | grep -qE "^backend/src/migrations/|^backend/migrations/"; then
            echo "has_migrations=true" >> $GITHUB_OUTPUT
            echo "Migration files changed - will run migrations"
          else
            echo "has_migrations=false" >> $GITHUB_OUTPUT
            echo "No migration files changed - skipping migrations"
          fi

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push backend
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          target: production
          push: true
          tags: |
            ${{ env.ECR_REGISTRY }}/faxi-backend:prod
            ${{ env.ECR_REGISTRY }}/faxi-backend:prod-${{ github.sha }}
          cache-from: type=registry,ref=${{ env.ECR_REGISTRY }}/faxi-backend:prod
          cache-to: type=inline
          platforms: linux/amd64

      - name: Build and push admin dashboard
        uses: docker/build-push-action@v5
        with:
          context: ./admin-dashboard
          file: ./admin-dashboard/Dockerfile
          push: true
          build-args: |
            NEXT_PUBLIC_API_URL=https://fax.faxi.jp
          tags: |
            ${{ env.ECR_REGISTRY }}/faxi-admin-dashboard:prod
            ${{ env.ECR_REGISTRY }}/faxi-admin-dashboard:prod-${{ github.sha }}
          cache-from: type=registry,ref=${{ env.ECR_REGISTRY }}/faxi-admin-dashboard:prod
          cache-to: type=inline
          platforms: linux/amd64

      - name: Build and push marketing website
        uses: docker/build-push-action@v5
        with:
          context: ./marketing-website
          file: ./marketing-website/Dockerfile
          push: true
          build-args: |
            NEXT_PUBLIC_API_URL=https://fax.faxi.jp
          tags: |
            ${{ env.ECR_REGISTRY }}/faxi-marketing-website:prod
            ${{ env.ECR_REGISTRY }}/faxi-marketing-website:prod-${{ github.sha }}
          cache-from: type=registry,ref=${{ env.ECR_REGISTRY }}/faxi-marketing-website:prod
          cache-to: type=inline
          platforms: linux/amd64

      - name: Register new task definitions
        run: |
          # Register backend task definition
          aws ecs register-task-definition \
            --cli-input-json file://aws/prod-backend-task-definition.json \
            --region ${{ env.AWS_REGION }}

          # Register admin task definition
          aws ecs register-task-definition \
            --cli-input-json file://aws/prod-admin-task-definition.json \
            --region ${{ env.AWS_REGION }}

          # Register marketing task definition
          aws ecs register-task-definition \
            --cli-input-json file://aws/prod-marketing-task-definition.json \
            --region ${{ env.AWS_REGION }}

      - name: Run database migrations
        if: steps.migration-check.outputs.has_migrations == 'true'
        run: |
          echo "Running database migrations..."

          # Get network config from backend service
          NETWORK_CONFIG=$(aws ecs describe-services \
            --cluster ${{ env.ECS_CLUSTER }} \
            --services faxi-prod-backend \
            --region ${{ env.AWS_REGION }} \
            --query 'services[0].networkConfiguration' \
            --output json)

          # Run migration as one-off task
          TASK_ARN=$(aws ecs run-task \
            --cluster ${{ env.ECS_CLUSTER }} \
            --task-definition faxi-prod-backend \
            --launch-type FARGATE \
            --network-configuration "$NETWORK_CONFIG" \
            --overrides '{"containerOverrides":[{"name":"backend","command":["npm","run","migrate"]}]}' \
            --region ${{ env.AWS_REGION }} \
            --query 'tasks[0].taskArn' \
            --output text)

          echo "Migration task: $TASK_ARN"

          # Wait for migration to complete
          aws ecs wait tasks-stopped \
            --cluster ${{ env.ECS_CLUSTER }} \
            --tasks "$TASK_ARN" \
            --region ${{ env.AWS_REGION }}

          # Check exit code
          EXIT_CODE=$(aws ecs describe-tasks \
            --cluster ${{ env.ECS_CLUSTER }} \
            --tasks "$TASK_ARN" \
            --region ${{ env.AWS_REGION }} \
            --query 'tasks[0].containers[0].exitCode' \
            --output text)

          if [ "$EXIT_CODE" != "0" ]; then
            echo "Migration failed with exit code: $EXIT_CODE"
            exit 1
          fi

          echo "Migrations completed successfully"

      - name: Deploy backend to ECS
        run: |
          aws ecs update-service \
            --cluster ${{ env.ECS_CLUSTER }} \
            --service faxi-prod-backend \
            --task-definition faxi-prod-backend \
            --force-new-deployment \
            --region ${{ env.AWS_REGION }}

      - name: Deploy admin dashboard to ECS
        run: |
          aws ecs update-service \
            --cluster ${{ env.ECS_CLUSTER }} \
            --service faxi-prod-admin \
            --task-definition faxi-prod-admin \
            --force-new-deployment \
            --region ${{ env.AWS_REGION }}

      - name: Deploy marketing website to ECS
        run: |
          aws ecs update-service \
            --cluster ${{ env.ECS_CLUSTER }} \
            --service faxi-prod-marketing \
            --task-definition faxi-prod-marketing \
            --force-new-deployment \
            --region ${{ env.AWS_REGION }}

      - name: Check deployment status
        run: |
          echo "=== Production Deployment Status ==="
          aws ecs describe-services \
            --cluster ${{ env.ECS_CLUSTER }} \
            --services faxi-prod-backend faxi-prod-admin faxi-prod-marketing \
            --region ${{ env.AWS_REGION }} \
            --query 'services[*].[serviceName,status,runningCount,desiredCount]' \
            --output table
